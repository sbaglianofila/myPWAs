<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Simon Says</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #4c1d95 0%, #7c2d12 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      position: fixed;
      inset: 0;
      overflow: hidden;
    }

    .container {
      width: 100%;
      max-width: 448px;
    }

    .header {
      text-align: center;
      margin-bottom: 32px;
    }

    .title {
      font-size: 56px;
      font-weight: bold;
      color: white;
      margin-bottom: 8px;
    }

    .subtitle {
      color: #e9d5ff;
      font-size: 14px;
    }

    .game-container {
      background: #1f2937;
      border-radius: 8px;
      box-shadow: 0 20px 25px rgba(0,0,0,0.3);
      padding: 24px;
      margin-bottom: 24px;
    }

    .stats-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      gap: 16px;
    }

    .stats {
      display: flex;
      gap: 16px;
    }

    .stat-box {
      color: white;
      padding: 8px 16px;
      border-radius: 8px;
    }

    .stat-box.level {
      background: #9333ea;
    }

    .stat-box.record {
      background: #a855f7;
    }

    .stat-label {
      font-size: 10px;
      opacity: 0.8;
    }

    .stat-value {
      font-size: 24px;
      font-weight: bold;
    }

    .btn-sound {
      background: #9333ea;
      color: white;
      border: none;
      padding: 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 20px;
      transition: background 0.2s;
    }

    .btn-sound:hover {
      background: #7e22ce;
    }

    .buttons-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    .simon-button {
      height: 128px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      transition: all 0.15s;
      box-shadow: 0 10px 15px rgba(0,0,0,0.3);
    }

    .simon-button:disabled {
      cursor: not-allowed;
      opacity: 0.8;
    }

    .simon-button.green {
      background: #22c55e;
    }

    .simon-button.green.active {
      background: #86efac;
      transform: scale(0.95);
      box-shadow: 0 0 20px rgba(34, 197, 94, 0.8);
    }

    .simon-button.red {
      background: #ef4444;
    }

    .simon-button.red.active {
      background: #fca5a5;
      transform: scale(0.95);
      box-shadow: 0 0 20px rgba(239, 68, 68, 0.8);
    }

    .simon-button.yellow {
      background: #facc15;
    }

    .simon-button.yellow.active {
      background: #fef08a;
      transform: scale(0.95);
      box-shadow: 0 0 20px rgba(250, 204, 21, 0.8);
    }

    .simon-button.blue {
      background: #3b82f6;
    }

    .simon-button.blue.active {
      background: #93c5fd;
      transform: scale(0.95);
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.8);
    }

    .btn-start {
      width: 100%;
      background: linear-gradient(to right, #22c55e, #16a34a);
      color: white;
      border: none;
      padding: 16px;
      border-radius: 8px;
      font-weight: bold;
      font-size: 20px;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
    }

    .btn-start:hover {
      background: linear-gradient(to right, #16a34a, #15803d);
    }

    .message {
      text-align: center;
      color: white;
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 16px;
      min-height: 28px;
    }

    .message.watching {
      color: #fbbf24;
      animation: pulse 1s infinite;
    }

    .message.playing {
      color: #4ade80;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .instructions {
      background: rgba(31, 41, 55, 0.8);
      border-radius: 8px;
      padding: 16px;
      text-align: center;
      font-size: 14px;
      color: #e9d5ff;
    }

    .instructions p {
      margin-bottom: 8px;
    }

    .instructions p:last-child {
      margin-bottom: 0;
    }

    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-content {
      background: #1f2937;
      border-radius: 8px;
      padding: 32px;
      text-align: center;
      max-width: 384px;
      margin: 16px;
      border: 2px solid #ef4444;
    }

    .modal-title {
      font-size: 36px;
      font-weight: bold;
      margin-bottom: 16px;
      color: #f87171;
    }

    .modal-score {
      font-size: 24px;
      margin-bottom: 8px;
      color: white;
    }

    .modal-best {
      color: #9ca3af;
      margin-bottom: 24px;
    }

    .btn-modal {
      background: linear-gradient(to right, #9333ea, #7e22ce);
      color: white;
      border: none;
      padding: 12px 32px;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      font-size: 18px;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-modal:hover {
      background: linear-gradient(to right, #7e22ce, #6b21a8);
    }

    .hidden {
      display: none;
    }
  </style>
  <link rel="manifest" href="manifest.json">
</head>
<body>
  <div class="container">
    <div class="header">
      <h1 class="title">SIMON</h1>
      <p class="subtitle">Memorizza la sequenza!</p>
    </div>

    <div class="game-container">
      <div class="stats-bar">
        <div class="stats">
          <div class="stat-box level">
            <div class="stat-label">Livello</div>
            <div class="stat-value" id="level">0</div>
          </div>
          <div class="stat-box record">
            <div class="stat-label">Record</div>
            <div class="stat-value" id="record">0</div>
          </div>
        </div>
        <button class="btn-sound" id="btn-sound" onclick="toggleSound()">ðŸ”Š</button>
      </div>

      <div class="buttons-grid">
        <button class="simon-button green" id="btn-0" onclick="handleClick(0)"></button>
        <button class="simon-button red" id="btn-1" onclick="handleClick(1)"></button>
        <button class="simon-button yellow" id="btn-2" onclick="handleClick(2)"></button>
        <button class="simon-button blue" id="btn-3" onclick="handleClick(3)"></button>
      </div>

      <div class="message" id="message"></div>

      <button class="btn-start" id="btn-start" onclick="startGame()">INIZIA</button>
    </div>

    <div class="instructions">
      <p>ðŸŽ® Memorizza la sequenza di colori</p>
      <p>ðŸ‘† Ripeti la sequenza toccando i pulsanti</p>
      <p>ðŸ”Š Ogni colore ha un suono diverso!</p>
    </div>
  </div>

  <div class="modal hidden" id="modal">
    <div class="modal-content">
      <h2 class="modal-title">Game Over!</h2>
      <p class="modal-score">Livello raggiunto: <span id="modal-level">0</span></p>
      <p class="modal-best">Record: <span id="modal-record">0</span></p>
      <button class="btn-modal" onclick="startGame()">â†» Rigioca</button>
    </div>
  </div>

  <script>
    const state = {
      sequence: [],
      playerSequence: [],
      isPlaying: false,
      isPlayerTurn: false,
      score: 0,
      bestScore: 0,
      gameOver: false,
      soundEnabled: true,
      audioContext: null
    };

    const colors = [
      { name: 'green', freq: 329.63 },
      { name: 'red', freq: 261.63 },
      { name: 'yellow', freq: 392.00 },
      { name: 'blue', freq: 440.00 }
    ];

    function init() {
      const saved = localStorage.getItem('simon-best');
      if (saved) state.bestScore = parseInt(saved);
      document.getElementById('record').textContent = state.bestScore;

      state.audioContext = new (window.AudioContext || window.webkitAudioContext)();
      updateMessage('');
    }

    function playSound(frequency) {
      if (!state.soundEnabled || !state.audioContext) return;

      const ctx = state.audioContext;
      const oscillator = ctx.createOscillator();
      const gainNode = ctx.createGain();

      oscillator.connect(gainNode);
      gainNode.connect(ctx.destination);

      oscillator.frequency.value = frequency;
      oscillator.type = 'sine';

      gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);

      oscillator.start(ctx.currentTime);
      oscillator.stop(ctx.currentTime + 0.3);
    }

    function toggleSound() {
      state.soundEnabled = !state.soundEnabled;
      document.getElementById('btn-sound').textContent = state.soundEnabled ? 'ðŸ”Š' : 'ðŸ”‡';
    }

    function startGame() {
      state.sequence = [];
      state.playerSequence = [];
      state.score = 0;
      state.gameOver = false;
      state.isPlaying = true;
      state.isPlayerTurn = false;

      document.getElementById('level').textContent = state.score;
      document.getElementById('btn-start').classList.add('hidden');
      document.getElementById('modal').classList.add('hidden');

      setTimeout(() => {
        addToSequence();
      }, 500);
    }

    function addToSequence() {
      const newColor = Math.floor(Math.random() * 4);
      state.sequence.push(newColor);
      playSequence();
    }

    async function playSequence() {
      state.isPlayerTurn = false;
      updateMessage('Guarda la sequenza...', 'watching');
      setButtonsEnabled(false);

      for (let i = 0; i < state.sequence.length; i++) {
        await sleep(500);
        activateButton(state.sequence[i]);
        playSound(colors[state.sequence[i]].freq);
        await sleep(400);
        deactivateButton(state.sequence[i]);
      }

      state.isPlayerTurn = true;
      state.playerSequence = [];
      updateMessage(`Tocca i colori! (0/${state.sequence.length})`, 'playing');
      setButtonsEnabled(true);
    }

    function handleClick(colorId) {
      if (!state.isPlayerTurn || state.gameOver) return;

      activateButton(colorId);
      playSound(colors[colorId].freq);

      setTimeout(() => deactivateButton(colorId), 300);

      state.playerSequence.push(colorId);
      updateMessage(`Tocca i colori! (${state.playerSequence.length}/${state.sequence.length})`, 'playing');

      const currentIndex = state.playerSequence.length - 1;

      if (state.playerSequence[currentIndex] !== state.sequence[currentIndex]) {
        endGame();
        return;
      }

      if (state.playerSequence.length === state.sequence.length) {
        state.score++;
        document.getElementById('level').textContent = state.score;
        state.isPlayerTurn = false;
        setButtonsEnabled(false);
        updateMessage('Corretto!', 'playing');

        setTimeout(() => {
          addToSequence();
        }, 1000);
      }
    }

    function endGame() {
      state.gameOver = true;
      state.isPlaying = false;
      state.isPlayerTurn = false;
      setButtonsEnabled(false);
      playSound(100);

      if (state.score > state.bestScore) {
        state.bestScore = state.score;
        localStorage.setItem('simon-best', state.score.toString());
        document.getElementById('record').textContent = state.bestScore;
      }

      document.getElementById('modal-level').textContent = state.score;
      document.getElementById('modal-record').textContent = state.bestScore;
      document.getElementById('modal').classList.remove('hidden');
      document.getElementById('btn-start').classList.remove('hidden');
    }

    function activateButton(id) {
      document.getElementById('btn-' + id).classList.add('active');
    }

    function deactivateButton(id) {
      document.getElementById('btn-' + id).classList.remove('active');
    }

    function setButtonsEnabled(enabled) {
      for (let i = 0; i < 4; i++) {
        document.getElementById('btn-' + i).disabled = !enabled;
      }
    }

    function updateMessage(text, className = '') {
      const msg = document.getElementById('message');
      msg.textContent = text;
      msg.className = 'message ' + className;
    }

    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    init();
  </script>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js');
      });
    }
  </script>
</body>
</html>